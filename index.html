<!-- Create a map using Leaflet, find and add some tile layers to the map. -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Leaflet</title>
    <!-- leaflet css -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        width: 100vw;
        height: 100vh;
      }
      .coordinate {
        position: absolute;
        bottom: 20px;
        right: 50%;
        background-color: antiquewhite;
      }
      .leaflet-popup-content-wrapper {
        background-color: rgb(205, 214, 206);
        color: #dc3030;
        border: 1px solid #dc3030;
        border-radius: 10px;
      }
    </style>
    script>
  </head>

  <body>
    <div id="map">
      <div class="leaflet-control coordinate"></div>
    </div>

    //install omnivore
    <script src="//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js"></script>
    <script src="index.js"></script>
  </body>
</html>
<!-- leaflet js -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script src="./data/point.js"></script>
<script src="./data/line.js"></script>
<script src="./data/polygon.js"></script>

<script>
  /* *********************************************
                     Map initialization
    ********************************************** */
  // Map initialization
  var map = L.map("map").setView([30.25, 120.166664], 13);
  //   *********************************************
  //                          Tile Layer
  //   **********************************************

  // WMS Tile Layer
  var nexrad = L.tileLayer.wms(
    "http://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0r.cgi",
    {
      layers: "nexrad-n0r-900913",
      format: "image/png",
      transparent: true,
      attribution: "Weather data Â© 2012 IEM Nexrad",
    }
  );
  var osm = L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution:
      '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
  });
  //   osm.addTo(map);

  //watercolor
  var watercolor = L.tileLayer(
    "https://tiles.stadiamaps.com/tiles/stamen_watercolor/{z}/{x}/{y}.{ext}",
    {
      minZoom: 1,
      maxZoom: 16,
      attribution:
        '&copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a> &copy; <a href="https://www.stamen.com/" target="_blank">Stamen Design</a> &copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      ext: "jpg",
    }
  );
  //   watercolor.addTo(map);

  //dark map
  var darkmap = L.tileLayer(
    "https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png",
    {
      attribution:
        '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: "abcd",
      maxZoom: 20,
    }
  );
  //   darkmap.addTo(map);

  //google map
  googleMap = googleStreets = L.tileLayer(
    "http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}",
    {
      maxZoom: 20,
      subdomains: ["mt0", "mt1", "mt2", "mt3"],
    }
  );
  googleMap.addTo(map);
  //googleSat
  googleSat = L.tileLayer("http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}", {
    maxZoom: 20,
    subdomains: ["mt0", "mt1", "mt2", "mt3"],
  });
  //   googleSat.addTo(map);

  /* *********************************************
                     marker
    ********************************************** */
  //   L.marker([30.25, 120.166664]).addTo(map);
  var myIcon = L.icon({
    iconUrl: "img/red_marker.png",
    iconSize: [40, 40],
    iconAnchor: [22, 94],
  });

  var singleMarker = L.marker([30.25, 120.166664], {
    icon: myIcon,
    draggable: true,
    autoPan: false,
  });

  var secondMarker = L.marker([30.2, 120.16], {
    icon: myIcon,
    draggable: true,
    autoPan: false,
  });
  var popup = singleMarker.bindPopup(
    "This is Hangzhou!" + singleMarker.getLatLng()
  );
  popup.addTo(map);
  //   console.log(singleMarker.toGeoJSON());
  //   *********************************************
  //                           GeoJSON
  //   **********************************************

  var pointData = L.geoJson(pointJson).addTo(map);
  var lineData = L.geoJson(lineJson).addTo(map);
  var polygonData = L.geoJson(polygonJson, {
    onEachFeature: function (feature, layer) {
      layer.bindPopup("<b>Name: </b> " + feature.properties.name);
    },
    style: {
      fillColor: "#ff0000",
      fillOpacity: 0.5,
      color: "#c0c0c0",
    },
  }).addTo(map);

  var baseMaps = {
    OSM: osm,
    Watercolor: watercolor,
    DarkMap: darkmap,
    GoogleMap: googleMap,
    GoogleSat: googleSat,
  };

  var overlayMaps = {
    SingleMarker: singleMarker,
    SecondMarker: secondMarker,
    Point: pointData,
    Line: lineData,
    Polygon: polygonData,
    Nexrad: nexrad, //add WMS layer
  };

  //   map.removeLayer(singleMarker);

  L.control.layers(baseMaps, overlayMaps, { collapsed: false }).addTo(map);
  /* *********************************************
                     Leaflet Event
    ********************************************** */
  map.on("mouseover", function () {
    console.log("Your Mouse is over the map!");
  });

  map.on("mousemove", function (e) {
    document.getElementsByClassName("coordinate")[0].innerHTML =
      "lat:" + e.latlng.lat + " | " + "lng:" + e.latlng.lng;
    console.log("lat:" + e.latlng.lat + "lng:" + e.latlng.lng);
  });

  /* *********************************************
    Load GeoJSON, CSV, gpx, wkt, topojson file in Leaflet 
    ********************************************** */
  // Load GeoJsoN from an external file
  //   var geojsonLayer = omnivore.geojson("./data/geojson/street.json").addTo(map);

  //   //zoom into geojson layer
  //   geojsonLayer.on("ready", function () {
  //     map.fitBounds(geojsonLayer.getBounds());
  //     //add popup
  //     geojsonLayer.eachLayer(function (layer) {
  //       layer.bindPopup("Name:" + layer.feature.properties.Name);
  //     });
  //   });
  // load kml file
  var kmlLayer = omnivore.kml("./data/kml/line.kml").addTo(map);
  //add popup
  kmlLayer.eachLayer(function (layer) {
    layer.bindPopup("Name:" + layer.feature.properties.name);
  });

  // Robust styling for KML: handle vector paths and markers separately
  kmlLayer.on("ready", function () {
    kmlLayer.eachLayer(function (layer) {
      // Vector features (lines/polygons) -> setStyle works
      if (layer instanceof L.Path) {
        layer.setStyle({
          color: "red",
          weight: 8,
          opacity: 0.85,
          fillOpacity: 0.4,
        });
        // keep / update popup if feature properties exist
        if (
          layer.feature &&
          layer.feature.properties &&
          layer.feature.properties.Name
        ) {
          layer.bindPopup("Name: " + layer.feature.properties.Name);
        }
      }
      // Point features parsed as L.Marker -> setStyle DOES NOT work
      else if (layer instanceof L.Marker) {
        var latlng = layer.getLatLng();
        var props = (layer.feature && layer.feature.properties) || {};
        var popupContent = props.Name
          ? "Name: " + props.Name
          : layer.getPopup && layer.getPopup()
          ? layer.getPopup().getContent()
          : null;

        // create a circleMarker so we can control style
        var styledPoint = L.circleMarker(latlng, {
          radius: 8,
          fillColor: "#e03e2d",
          color: "#9b2a2a",
          weight: 1,
          opacity: 1,
          fillOpacity: 0.9,
        });
        if (popupContent) styledPoint.bindPopup(popupContent);

        // replace original marker with styled circleMarker in the same group
        kmlLayer.removeLayer(layer);
        kmlLayer.addLayer(styledPoint);
      }
    });

    // zoom to layer and ensure popups bound
    if (kmlLayer.getBounds && !kmlLayer.getBounds().isValid) {
      // fallback: do nothing if no bounds
    } else {
      map.fitBounds(kmlLayer.getBounds());
    }
  });

  //all methods of omnivore
  //   var map = L.mapbox.map('map', 'mapbox.streets')
  //     .setView([38, -102.0], 5);

  // omnivore.csv('a.csv').addTo(map);
  // omnivore.gpx('a.gpx').addTo(map);
  // omnivore.kml('a.kml').addTo(map);
  // omnivore.wkt('a.wkt').addTo(map);
  // omnivore.topojson('a.topojson').addTo(map);
  // omnivore.geojson('a.geojson').addTo(map);
  // omnivore.polyline('a.txt').addTo(map);
</script>
